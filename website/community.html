<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunecamp Community - Discover Independent Music</title>
    <meta name="description"
        content="Discover independent artists using Tunecamp. A decentralized community directory of music websites.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Community-specific styles */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin: var(--space-xl) 0;
        }

        .site-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .site-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .site-card-cover {
            height: 180px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .site-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .site-card-content {
            padding: var(--space-lg);
        }

        .site-card h3 {
            font-size: 1rem;
            margin-bottom: var(--space-xs);
            font-weight: 600;
        }

        .site-card h3 a {
            color: var(--text-primary);
            text-decoration: none;
        }

        .site-card h3 a:hover {
            color: var(--accent);
        }

        .site-card .artist {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .site-card .meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            background: var(--bg-surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: var(--space-xl);
        }

        .status-bar .live {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
            color: #10b981;
        }

        .sites-count {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
        }

        .cta-section {
            background: var(--accent);
            color: white;
            padding: var(--space-xl);
            border-radius: 8px;
            text-align: center;
            margin: var(--space-2xl) 0;
        }

        .cta-section h3 {
            color: white;
            margin-bottom: var(--space-sm);
        }

        .cta-section p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: var(--space-lg);
        }

        .cta-section .btn {
            background: white;
            color: var(--accent);
        }

        .cta-section .btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header style="border-bottom: none; padding-bottom: var(--space-lg);">
            <p style="margin-bottom: var(--space-lg);"><a href="index.html"
                    style="color: var(--text-muted); font-size: 0.875rem;">‚Üê Back to Tunecamp</a></p>
            <h1>üåê Community</h1>
            <p class="subtitle">Discover independent artists using Tunecamp</p>

            <div class="download-buttons">
                <a href="player.html" class="btn">üéµ Listen Now</a>
                <a href="index.html" class="btn btn-secondary">Get Tunecamp</a>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="live">
                <span class="live-dot"></span>
                Live updates
            </div>
            <div class="sites-count" id="siteCount">Loading sites...</div>
        </div>

        <!-- Sites Grid -->
        <div class="sites-grid" id="sitesGrid">
            <div class="empty-state">
                <div class="icon">‚è≥</div>
                <p>Connecting to the network...</p>
            </div>
        </div>

        <!-- CTA -->
        <div class="cta-section">
            <h3>üéµ Join the Community</h3>
            <p>Your Tunecamp site is automatically registered when visitors browse it.<br>
                No sign-up needed ‚Äî it's fully decentralized via GunDB.</p>
            <a href="player.html" class="btn" style="margin-right: 10px;">üéµ Listen Now</a>
            <a href="index.html" class="btn">Get Started</a>
        </div>

        <footer>
            <div class="footer-links">
                <a href="https://github.com/scobru/tunecamp">GitHub</a>
                <a href="https://www.npmjs.com/package/tunecamp">NPM</a>
                <a href="player.html">üéµ Player</a>
                <a href="index.html">Home</a>
                <a href="https://buymeacoffee.com/scobru" target="_blank">‚òï Support</a>
            </div>
            <div class="footer-note">
                Powered by GunDB. Made with ‚ù§Ô∏è by <a href="https://github.com/scobru" target="_blank">scobru</a>
            </div>
        </footer>
    </div>

    <!-- GunDB -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script>
        const REGISTRY_PEERS = [
            'https://gun.defucc.me/gun',
            'https://gun.o8.is/gun',
            'https://shogun-relay.scobrudot.dev/gun',
            'https://relay.peer.ooo/gun',
        ];
        const REGISTRY_ROOT = 'shogun';
        const REGISTRY_NAMESPACE = 'tunecamp-community';

        const gun = Gun({ peers: REGISTRY_PEERS, localStorage: true });
        const sitesMap = new Map();

        function loadSites() {
            gun.get(REGISTRY_ROOT)
                .get(REGISTRY_NAMESPACE)
                .get('sites')
                .map()
                .on((data, key) => {
                    if (data && data.url) {
                        // Skip incomplete, untitled, or localhost sites
                        if (
                            data.url.includes('localhost') ||
                            !data.coverImage ||
                            !data.title ||
                            data.title === 'Untitled' ||
                            data.title === 'TuneCamp Server' // Default name, often unconfigured
                        ) return;

                        sitesMap.set(key, {
                            id: key,
                            url: data.url,
                            title: data.title,
                            artistName: data.artistName || '',
                            coverImage: data.coverImage,
                            registeredAt: data.registeredAt,
                            lastSeen: data.lastSeen,
                        });

                        renderSites();
                    }
                });

            // Show empty state after timeout
            setTimeout(() => {
                if (sitesMap.size === 0) {
                    document.getElementById('sitesGrid').innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="icon">üéµ</div>
                            <h3>No sites yet</h3>
                            <p>Be the first! Create a Tunecamp site and your site will appear here automatically.</p>
                        </div>
                    `;
                    document.getElementById('siteCount').textContent = '0 sites';
                }
            }, 5000);
        }

        function renderSites() {
            // Deduplicate by title + artist, keeping only the most recent (highest lastSeen)
            const deduped = new Map();
            Array.from(sitesMap.values()).forEach(site => {
                const dedupKey = `${(site.title || '').toLowerCase()}::${(site.artistName || '').toLowerCase()}`;
                const existing = deduped.get(dedupKey);
                if (!existing || (site.lastSeen || 0) > (existing.lastSeen || 0)) {
                    deduped.set(dedupKey, site);
                }
            });

            const sites = Array.from(deduped.values());
            sites.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));

            document.getElementById('siteCount').textContent = `${sites.length} site${sites.length !== 1 ? 's' : ''}`;

            const grid = document.getElementById('sitesGrid');
            grid.innerHTML = sites.map(site => {
                const coverHtml = site.coverImage
                    ? `<img src="${escapeHtml(site.coverImage)}" alt="${escapeHtml(site.title)}" onerror="this.parentElement.innerHTML='üéµ'">`
                    : 'üéµ';

                const lastSeen = site.lastSeen ? formatDate(site.lastSeen) : 'Unknown';

                return `
                    <div class="site-card">
                        <div class="site-card-cover">${coverHtml}</div>
                        <div class="site-card-content">
                            <h3><a href="${escapeHtml(site.url)}" target="_blank">${escapeHtml(site.title)}</a></h3>
                            ${site.artistName ? `<div class="artist">by ${escapeHtml(site.artistName)}</div>` : ''}
                            <div class="meta">
                                <span>Last seen: ${lastSeen}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 5) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        document.addEventListener('DOMContentLoaded', loadSites);
    </script>
</body>

</html>